pipeline {
    agent any
    environment {
            registry = "narenraj48/my-images"
            registryCredential = 'dockerhub'
            dockerImage=''
          }
    stages {
        stage('Build user-service') {
            steps {
                dir("budget-tracker/services/user-service") {
                    sh 'mvn -B -DskipTests clean package'
                }
            }
        }
        stage('Test user-service') {
            steps {
                dir("budget-tracker/services/user-service") {
                    sh 'mvn test'
                }
            }
        }
        stage('Building image') {
              steps{
              dir("budget-tracker/services/user-service"){
//               script {
//                          dockerImage = docker.build registry + ":$BUILD_NUMBER"
                        sh 'docker login -u narenraj48 -p Raina#123'
                        sh 'docker build -t narenraj48/my-images:usertest . --no-cache'
                        sh 'docker push narenraj48/my-images:usertest'
//                        }
              }
              }
            }
//             stage('Deploy Image') {
//               steps{
//                 script {
//                   docker.withRegistry( '', registryCredential ) {
//                     dockerImage.push()
//                   }
//                 }
//               }
//             }
        stage('Build budget-service') {
                    steps {
                        dir("budget-tracker/services/budget-service") {
                            sh 'mvn -B -DskipTests clean package'
                        }
                    }
                }
                stage('Test budget-service') {
                    steps {
                        dir("budget-tracker/services/budget-service") {
                            sh 'mvn test'
                        }
                    }
                }
                stage('Build transaction-service') {
                            steps {
                                dir("budget-tracker/services/transaction-service") {
                                    sh 'mvn -B -DskipTests clean package'
                                }
                            }
                        }
                        stage('Test transaction-service') {
                            steps {
                                dir("budget-tracker/services/transaction-service") {
                                    sh 'mvn test'
                                }
                            }
                        }
                        stage('Build notification-service') {
                                    steps {
                                        dir("budget-tracker/services/notification-service") {
                                            sh 'mvn -B -DskipTests clean package'
                                        }
                                    }
                                }
                                stage('Test notification-service') {
                                    steps {
                                        dir("budget-tracker/services/notification-service") {
                                            sh 'mvn test'
                                        }
                                    }
                                }
    }
}