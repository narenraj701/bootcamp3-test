pipeline {
    agent any
    environment {
            registry = "docker.pkg.github.com/narenraj701/bootcamp3-test/user"
            registryCredential = 'github-registry'
            dockerImage=''
          }
    stages {
        stage('Build user-service') {
            steps {
                dir("budget-tracker/services/user-service") {
                    sh 'mvn -B -DskipTests clean package'
                }
            }
        }
        stage('Test user-service') {
            steps {
                dir("budget-tracker/services/user-service") {
                    sh 'mvn test'
                }
            }
        }
        stage('Building Docker Image') {
              steps{
              dir("budget-tracker/services/user-service"){
              script {
                         dockerImage = docker.build registry + ":$BUILD_NUMBER"
                       }
              }
              }
            }
            stage('Deploy Docker Image to Dockerhub') {
              steps{
//               sh 'cat ~/GH_TOKEN.txt | docker login docker.pkg.github.com -u narenraj701 --password-stdin'
               sh 'docker login docker.pkg.github.com -u narenraj701 -p ${GH_TOKEN}'
              sh 'docker push '+registry+":$BUILD_NUMBER"
//                 script {
//
//                   docker.withRegistry( '', registryCredential ) {
//                     dockerImage.push()
//                   }
//                 }
              }
            }
        stage('Build budget-service') {
                    steps {
                        dir("budget-tracker/services/budget-service") {
                            sh 'mvn -B -DskipTests clean package'
                        }
                    }
                }
                stage('Test budget-service') {
                    steps {
                        dir("budget-tracker/services/budget-service") {
                            sh 'mvn test'
                        }
                    }
                }
                stage('Build transaction-service') {
                            steps {
                                dir("budget-tracker/services/transaction-service") {
                                    sh 'mvn -B -DskipTests clean package'
                                }
                            }
                        }
                        stage('Test transaction-service') {
                            steps {
                                dir("budget-tracker/services/transaction-service") {
                                    sh 'mvn test'
                                }
                            }
                        }
                        stage('Build notification-service') {
                                    steps {
                                        dir("budget-tracker/services/notification-service") {
                                            sh 'mvn -B -DskipTests clean package'
                                        }
                                    }
                                }
                                stage('Test notification-service') {
                                    steps {
                                        dir("budget-tracker/services/notification-service") {
                                            sh 'mvn test'
                                        }
                                    }
                                }
    }
}